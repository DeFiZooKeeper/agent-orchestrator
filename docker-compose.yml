# ============================================================
# DeFiZoo Agent Orchestrator — Docker Compose
# ============================================================
# Runs OpenClaw with multi-agent routing:
#   coordinator  → general questions, DMs, cross-domain coordination
#   frontend     → frontend development (brains/frontend)
#   backend      → backend development (brains/backend)
#   solidity     → Solidity / smart contracts (brains/solidity)
#   hr           → HR / people ops (brains/hr)
#
# Quick start:
#   cp .env.example .env        # fill in your tokens + Discord IDs
#   ./setup-brains.sh           # clone/init brain repos
#   docker compose up -d        # build + start
#   docker compose logs -f      # watch it boot
#
# Control UI: http://localhost:18789  (NOT 0.0.0.0 — needs secure context)
#
# Docs: https://docs.openclaw.ai/channels/discord
#       https://docs.openclaw.ai/concepts/multi-agent
# ============================================================

services:
  # Fix volume ownership before the gateway starts.
  # The named volume is created by Docker as root; OpenClaw runs as uid 1000 (node).
  openclaw-init:
    image: alpine:3.20
    container_name: openclaw-init
    restart: "no"
    command:
      - sh
      - "-c"
      - |
        chown -R 1000:1000 /data
    volumes:
      - openclaw_config:/data

  openclaw:
    build:
      context: "https://github.com/openclaw/openclaw.git#v2026.2.6"
      dockerfile: Dockerfile
    container_name: openclaw-gateway
    restart: unless-stopped
    init: true
    env_file:
      - .env
    depends_on:
      openclaw-init:
        condition: service_completed_successfully

    # Host-side 127.0.0.1 binding keeps the gateway off the network.
    # Inside the container the gateway binds to lan (0.0.0.0) so Docker
    # port-forwarding can reach it.  Access the Control UI at
    # http://localhost:${OPENCLAW_PORT} (secure context).
    ports:
      - "127.0.0.1:${OPENCLAW_PORT:-18789}:${OPENCLAW_PORT:-18789}"

    environment:
      - HOME=/home/node
      - TERM=xterm-256color
      - NODE_ENV=production
      - TZ=${TZ:-UTC}
      # Gateway — "lan" is required in Docker so port-forwarding works.
      # Docs: https://docs.openclaw.ai/gateway/configuration-reference#gateway
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      - OPENCLAW_GATEWAY_BIND=${OPENCLAW_GATEWAY_BIND:-lan}
      - OPENCLAW_GATEWAY_PORT=${OPENCLAW_PORT:-18789}
      - OPENCLAW_DISABLE_BONJOUR=1
      - GOG_KEYRING_PASSWORD=${GOG_KEYRING_PASSWORD:-}
      # LLM providers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY:-}
      # Discord
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      # GitHub — used for authenticated git operations
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_ORG=${GITHUB_ORG:-DeFiZooKeeper}
      # PATH
      - PATH=/home/node/.local/bin:/home/node/.npm-global/bin:/usr/local/bin:/usr/bin:/bin

    volumes:
      - openclaw_config:/home/node/.openclaw
      # Config (read-only)
      - ./state:/mnt/state:ro
      # Coordinator workspace
      - ./workspace:/home/node/.openclaw/workspace
      # Brain repos → agent workspaces
      - ./brains/frontend:/home/node/.openclaw/workspace-frontend
      - ./brains/backend:/home/node/.openclaw/workspace-backend
      - ./brains/solidity:/home/node/.openclaw/workspace-solidity
      - ./brains/hr:/home/node/.openclaw/workspace-hr
      - ./brains/marketing:/home/node/.openclaw/workspace-marketing

    command:
      - sh
      - "-c"
      - |
        # Create required directories
        mkdir -p ~/.local/bin ~/.local/share ~/.npm-global \
                 ~/.openclaw/credentials

        # Keep npm global installs writable for non-root runtime.
        npm config set prefix ~/.npm-global

        # Create agent session directories
        for agent in coordinator frontend backend solidity hr marketing; do
          mkdir -p ~/.openclaw/agents/$$agent/sessions
        done

        # Create openclaw CLI alias
        echo '#!/bin/sh' > ~/.local/bin/openclaw
        echo 'exec node /app/dist/index.js "$@"' >> ~/.local/bin/openclaw
        chmod +x ~/.local/bin/openclaw

        # --- Configure git identity for the agent ---
        git config --global user.name "Zoo Keeper"
        git config --global user.email "zookeeper@defizoo.ai"
        git config --global init.defaultBranch main

        # --- Install OpenCode CLI if not present ---
        if ! command -v opencode >/dev/null 2>&1; then
          echo "[setup] Installing OpenCode CLI..."
          npm install -g opencode-ai 2>/dev/null \
            && echo "[setup] opencode installed" \
            || echo "[setup] opencode install failed (non-fatal)"
        fi

        # Apply config BEFORE doctor so doctor validates the real config.
        cp /mnt/state/openclaw.json ~/.openclaw/openclaw.json

        # Doctor: diagnose + migrate. Docs: https://docs.openclaw.ai/gateway/doctor
        openclaw doctor
        sleep 1

        # Start gateway in the foreground (no systemd in containers).
        # --bind must be one of: loopback | lan | tailnet | auto | custom
        exec node dist/index.js gateway \
          --bind "$${OPENCLAW_GATEWAY_BIND}" \
          --port "$${OPENCLAW_GATEWAY_PORT}" \
          --allow-unconfigured

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node dist/index.js health --token \"$OPENCLAW_GATEWAY_TOKEN\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  openclaw_config:
    name: openclaw_config
