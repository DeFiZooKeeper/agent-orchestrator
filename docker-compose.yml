# ============================================================
# DeFiZoo Agent Orchestrator — Docker Compose
# ============================================================
# Runs OpenClaw with multi-agent routing:
#   coordinator  → general questions, DMs, cross-domain coordination
#   frontend     → frontend development (brains/frontend)
#   backend      → backend development (brains/backend)
#   solidity     → Solidity / smart contracts (brains/solidity)
#   hr           → HR / people ops (brains/hr)
#
# Quick start:
#   cp .env.example .env        # fill in your tokens + Discord IDs
#   ./setup-brains.sh           # clone/init brain repos
#   docker compose up -d        # build + start
#   docker compose logs -f      # watch it boot
#
# Docs: https://docs.openclaw.ai/channels/discord
#       https://docs.openclaw.ai/concepts/multi-agent
# ============================================================

version: '3.8'

services:
  openclaw:
    build:
      context: "https://github.com/openclaw/openclaw.git#v2026.2.6"
      dockerfile: Dockerfile
    container_name: openclaw-gateway
    restart: unless-stopped
    init: true
    user: root

    ports:
      - "127.0.0.1:${OPENCLAW_PORT:-18789}:18789"

    environment:
      - HOME=/home/node
      - TERM=xterm-256color
      - NODE_ENV=production
      - TZ=${TZ:-UTC}
      # Gateway
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      - OPENCLAW_GATEWAY_BIND=${OPENCLAW_GATEWAY_BIND:-lan}
      - OPENCLAW_GATEWAY_PORT=18789
      - OPENCLAW_DISABLE_BONJOUR=1
      # LLM providers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY:-}
      # Discord
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      # GitHub — used for authenticated git operations
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_ORG=${GITHUB_ORG:-DeFiZooKeeper}
      # PATH
      - PATH=/home/node/.local/bin:/home/node/.npm-global/bin:/usr/local/bin:/usr/bin:/bin

    volumes:
      - openclaw_config:/home/node/.openclaw
      # Config (read-only)
      - ./state:/mnt/state:ro
      # Coordinator workspace
      - ./workspace:/home/node/.openclaw/workspace
      # Brain repos → agent workspaces
      - ./brains/frontend:/home/node/.openclaw/workspace-frontend
      - ./brains/backend:/home/node/.openclaw/workspace-backend
      - ./brains/solidity:/home/node/.openclaw/workspace-solidity
      - ./brains/hr:/home/node/.openclaw/workspace-hr
      - ./brains/marketing:/home/node/.openclaw/workspace-marketing

    command:
      - sh
      - "-c"
      - |
        # Create required directories
        mkdir -p ~/.local/bin ~/.local/share ~/.npm-global \
                 ~/.openclaw/credentials

        # Create agent session directories
        for agent in coordinator frontend backend solidity hr marketing; do
          mkdir -p ~/.openclaw/agents/$agent/sessions
        done

        # Create openclaw CLI alias
        echo '#!/bin/sh' > ~/.local/bin/openclaw
        echo 'exec node /app/dist/index.js "$@"' >> ~/.local/bin/openclaw
        chmod +x ~/.local/bin/openclaw

        # --- Configure git identity for the agent ---
        git config --global user.name "Zoo Keeper"
        git config --global user.email "zookeeper@defizoo.ai"
        git config --global init.defaultBranch main

        # --- Install OpenCode CLI if not present ---
        if ! command -v opencode >/dev/null 2>&1; then
          echo "[setup] Installing OpenCode CLI..."
          npm install -g opencode-ai 2>/dev/null \
            && echo "[setup] opencode installed" \
            || echo "[setup] opencode install failed (non-fatal)"
        fi

        # Run doctor first
        openclaw doctor
        sleep 1

        # Apply our config
        cp /mnt/state/openclaw.json ~/.openclaw/openclaw.json

        # Start gateway
        exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  openclaw_config:
    name: openclaw_config
